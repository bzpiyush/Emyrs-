{
  "scenario": "azmove-migration",
  "description": "AzMove FcShell commands for Merlin migration",
  
  "_workflow": {
    "step1": "Deploy resources (ARM template)",
    "step2": "Get VM Unique ID from Azure Portal or deployment output",
    "step3": "Query Kusto (MycroftContainerSnapshot_Latest) to get TenantName, ClusterName, Cluster",
    "step4": "Run Validate API on SAW machine",
    "step5": "Run Migrate API on SAW machine", 
    "step6": "Check AzMoveDiagnostics for results"
  },

  "_kusto_query": {
    "cluster": "azcore.centralus.kusto.windows.net",
    "database": "AzureCP",
    "table": "MycroftContainerSnapshot_Latest",
    "query": "cluster('azcore.centralus.kusto.windows.net').database('AzureCP').MycroftContainerSnapshot_Latest | where VirtualMachineUniqueId == '<VM_UNIQUE_ID>' | project Cluster, TenantName, ClusterName",
    "output_mapping": {
      "Cluster": "Use for Get-AzMove -Name (e.g., uscentraleuap-prod-b)",
      "TenantName": "Use for $tenantName (e.g., 20499ca6-ab49-46ff-968e-7aedddcbd95e)",
      "ClusterName": "Use for FabricId (e.g., CDM06PrdApp17)"
    }
  },

  "_region_endpoints": {
    "note": "The endpoint comes directly from Kusto 'Cluster' column - no need to guess!",
    "useast2euap": {
      "description": "East Canary - has multiple AZs (a, b, c, d)",
      "example": "useast2euap-prod-b"
    },
    "uscentraleuap": {
      "description": "Central Canary - has single AZ (b only)",
      "example": "uscentraleuap-prod-b"
    }
  },

  "commands": {
    "step1_get_azmove": {
      "description": "Get AzMove endpoint - use Cluster value from Kusto directly!",
      "command": "$AzMove = Get-AzMove -Name <CLUSTER_FROM_KUSTO>",
      "example": "$AzMove = Get-AzMove -Name uscentraleuap-prod-b"
    },
    
    "step2_set_variables": {
      "description": "Set subscription and tenant variables",
      "commands": [
        "$crpSubscriptionId = \"<SUBSCRIPTION_ID>\"",
        "$tenantName = \"<TENANT_NAME_FROM_KUSTO>\"",
        "$fabricId = \"<CLUSTER_NAME_FROM_KUSTO>\""
      ],
      "notes": {
        "crpSubscriptionId": "The subscription ID where resources are created",
        "tenantName": "TenantName column from Kusto (e.g., 20499ca6-ab49-46ff-968e-7aedddcbd95e)",
        "fabricId": "ClusterName column from Kusto (e.g., CDM06PrdApp17)"
      }
    },

    "step3_create_migration_input": {
      "description": "Create and configure migration input object",
      "commands": [
        "$migrationInput = New-AzMoveObject AzMove.Controller.MigrateRunningTenantToMerlinInput",
        "$migrationInput | Update-AzMoveObject -PropertyName FabricId -PropertyValue $fabricId",
        "$migrationInput | Update-AzMoveObject -PropertyName NrpSubscriptionId -PropertyValue $crpSubscriptionId",
        "$migrationInput | Update-AzMoveObject -PropertyName RegionalNetworkResourceChannelType -PropertyValue \"ViaPubSub\"",
        "$migrationInput | Update-AzMoveObject -PropertyName VipGoalStateChannelType -PropertyValue \"ViaPubSub\"",
        "$migrationInput | Update-AzMoveObject -PropertyName RollbackMode -PropertyValue \"Optimized\""
      ],
      "fixed_values": {
        "RegionalNetworkResourceChannelType": "ViaPubSub",
        "VipGoalStateChannelType": "ViaPubSub",
        "RollbackMode": "Optimized"
      },
      "dynamic_values": {
        "FabricId": "ClusterName from Kusto (e.g., CDM06PrdApp17)",
        "NrpSubscriptionId": "Same as crpSubscriptionId"
      }
    },

    "step4_validate_api": {
      "description": "Run validation API (run this FIRST)",
      "command": "$result = ($AzMove | Invoke-AzMoveApi -MethodName AzMoveService_ValidateMigrateRunningTenantToMerlinAsyncByCrpsubscriptionidTenantnameMigrationinputAsync -Parameters @($crpSubscriptionId, $tenantName, $migrationInput)).Result",
      "notes": "Always run validation before actual migration"
    },

    "step5_migrate_api": {
      "description": "Run actual migration API (run AFTER validation succeeds)",
      "command": "$result = ($AzMove | Invoke-AzMoveApi -MethodName AzMoveService_MigrateRunningTenantToMerlinAsyncByCrpsubscriptionidTenantnameMigrationinputAsync -Parameters @($crpSubscriptionId, $tenantName, $migrationInput)).Result",
      "notes": "Only run this after validation passes"
    }
  },

  "_complete_script_template": "See azmove-complete-script.ps1 for ready-to-use script"
}
